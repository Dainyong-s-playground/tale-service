<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="kkk.dainyong.tale.repository.FairyTaleOwnershipRepository">
    <select id="findUserIdByProfileId" resultType="String">
        SELECT k.ID
        FROM KUSERS k
                 JOIN PROFILES p ON k.ID = p.USER_ID
        WHERE p.ID = #{profileId}
    </select>

    <select id="findPurchaseByUserIdAndFairyTaleId" resultType="kkk.dainyong.tale.model.PurchaseList">
        SELECT *
        FROM PURCHASE_LIST
        WHERE USER_ID = #{userId}
          AND FAIRYTALE_ID = #{fairyTaleId}
    </select>

    <select id="findActiveRentalByUserIdAndFairyTaleId" resultType="kkk.dainyong.tale.model.RentalList">
        SELECT *
        FROM RENTAL_LIST
        WHERE USER_ID = #{userId}
          AND FAIRYTALE_ID = #{fairyTaleId}
          AND END_DATE > SYSDATE
    </select>

    <select id="findFairyTaleById" resultType="kkk.dainyong.tale.model.FairyTale">
        SELECT *
        FROM FAIRYTALES
        WHERE id = #{fairyTaleId}
    </select>

    <insert id="saveRental" parameterType="kkk.dainyong.tale.model.RentalList">
        INSERT INTO RENTAL_LIST (USER_ID, FAIRYTALE_ID, START_DATE, END_DATE)
        VALUES (#{userId}, #{fairyTaleId}, #{startDate}, #{endDate})
    </insert>

    <insert id="savePurchase" parameterType="kkk.dainyong.tale.model.PurchaseList">
        INSERT INTO PURCHASE_LIST (USER_ID, FAIRYTALE_ID, PURCHASE_DATE)
        VALUES (#{userId}, #{fairyTaleId}, #{purchaseDate})
    </insert>

    <select id="findRentalListByUserId" resultType="kkk.dainyong.tale.model.RentalList">
        SELECT USER_ID, FAIRYTALE_ID, START_DATE, END_DATE
        FROM RENTAL_LIST
        WHERE USER_ID = #{userId}
        ORDER BY START_DATE DESC
    </select>

    <select id="findPurchaseListByUserId" resultType="kkk.dainyong.tale.model.PurchaseList">
        SELECT USER_ID, FAIRYTALE_ID, PURCHASE_DATE
        FROM PURCHASE_LIST
        WHERE USER_ID = #{userId}
        ORDER BY PURCHASE_DATE DESC
    </select>

    <select id="findPurchaseListByProfileId" resultType="kkk.dainyong.tale.model.PurchaseList">
        SELECT p.USER_ID, p.FAIRYTALE_ID, p.PURCHASE_DATE
        FROM PURCHASE_LIST p
        JOIN PROFILES pr ON p.USER_ID = pr.USER_ID
        WHERE pr.ID = #{profileId}
        ORDER BY p.PURCHASE_DATE DESC
    </select>

    <select id="findRentalListByProfileId" resultType="kkk.dainyong.tale.model.RentalList">
        SELECT r.USER_ID, r.FAIRYTALE_ID, r.START_DATE, r.END_DATE
        FROM RENTAL_LIST r
        JOIN PROFILES pr ON r.USER_ID = pr.USER_ID
        WHERE pr.ID = #{profileId}
        ORDER BY r.START_DATE DESC
    </select>
</mapper>